"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
/**
 * @license
 * Copyright Google Inc. All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
const core_1 = require("@angular-devkit/core");
exports.NodeWatchFileSystem = require('webpack/lib/node/NodeWatchFileSystem');
class VirtualFileSystemDecorator {
    constructor(_inputFileSystem, _webpackCompilerHost) {
        this._inputFileSystem = _inputFileSystem;
        this._webpackCompilerHost = _webpackCompilerHost;
    }
    _readFileSync(path) {
        if (this._webpackCompilerHost.fileExists(path)) {
            return this._webpackCompilerHost.readFileBuffer(path) || null;
        }
        return null;
    }
    _statSync(path) {
        if (this._webpackCompilerHost.fileExists(path)) {
            return this._webpackCompilerHost.stat(path);
        }
        return null;
    }
    getVirtualFilesPaths() {
        return this._webpackCompilerHost.getNgFactoryPaths();
    }
    stat(path, callback) {
        const result = this._statSync(path);
        if (result) {
            callback(null, result);
        }
        else {
            this._inputFileSystem.stat(path, callback);
        }
    }
    readdir(path, callback) {
        this._inputFileSystem.readdir(path, callback);
    }
    readFile(path, callback) {
        const result = this._readFileSync(path);
        if (result) {
            callback(null, result);
        }
        else {
            this._inputFileSystem.readFile(path, callback);
        }
    }
    readJson(path, callback) {
        this._inputFileSystem.readJson(path, callback);
    }
    readlink(path, callback) {
        this._inputFileSystem.readlink(path, callback);
    }
    statSync(path) {
        const result = this._statSync(path);
        return result || this._inputFileSystem.statSync(path);
    }
    readdirSync(path) {
        return this._inputFileSystem.readdirSync(path);
    }
    readFileSync(path) {
        const result = this._readFileSync(path);
        return result || this._inputFileSystem.readFileSync(path);
    }
    readJsonSync(path) {
        return this._inputFileSystem.readJsonSync(path);
    }
    readlinkSync(path) {
        return this._inputFileSystem.readlinkSync(path);
    }
    purge(changes) {
        if (typeof changes === 'string') {
            this._webpackCompilerHost.invalidate(changes);
        }
        else if (Array.isArray(changes)) {
            changes.forEach((fileName) => this._webpackCompilerHost.invalidate(fileName));
        }
        if (this._inputFileSystem.purge) {
            this._inputFileSystem.purge(changes);
        }
    }
}
exports.VirtualFileSystemDecorator = VirtualFileSystemDecorator;
class VirtualWatchFileSystemDecorator extends exports.NodeWatchFileSystem {
    constructor(_virtualInputFileSystem, _replacements) {
        super(_virtualInputFileSystem);
        this._virtualInputFileSystem = _virtualInputFileSystem;
        this._replacements = _replacements;
    }
    watch(files, dirs, missing, startTime, options, callback, // tslint:disable-line:no-any
    callbackUndelayed) {
        const reverseReplacements = new Map();
        const reverseTimestamps = (map) => {
            for (const entry of Array.from(map.entries())) {
                const original = reverseReplacements.get(entry[0]);
                if (original) {
                    map.set(original, entry[1]);
                    map.delete(entry[0]);
                }
            }
            return map;
        };
        const newCallbackUndelayed = (filename, timestamp) => {
            const original = reverseReplacements.get(filename);
            if (original) {
                this._virtualInputFileSystem.purge(original);
                callbackUndelayed(original, timestamp);
            }
            else {
                callbackUndelayed(filename, timestamp);
            }
        };
        const newCallback = (err, filesModified, contextModified, missingModified, fileTimestamps, contextTimestamps) => {
            // Update fileTimestamps with timestamps from virtual files.
            const virtualFilesStats = this._virtualInputFileSystem.getVirtualFilesPaths()
                .map((fileName) => ({
                path: fileName,
                mtime: +this._virtualInputFileSystem.statSync(fileName).mtime,
            }));
            virtualFilesStats.forEach(stats => fileTimestamps.set(stats.path, +stats.mtime));
            callback(err, filesModified.map(value => reverseReplacements.get(value) || value), contextModified.map(value => reverseReplacements.get(value) || value), missingModified.map(value => reverseReplacements.get(value) || value), reverseTimestamps(fileTimestamps), reverseTimestamps(contextTimestamps));
        };
        const mapReplacements = (original) => {
            if (!this._replacements) {
                return original;
            }
            const replacements = this._replacements;
            return original.map(file => {
                if (typeof replacements === 'function') {
                    const replacement = core_1.getSystemPath(replacements(core_1.normalize(file)));
                    if (replacement !== file) {
                        reverseReplacements.set(replacement, file);
                    }
                    return replacement;
                }
                else {
                    const replacement = replacements.get(core_1.normalize(file));
                    if (replacement) {
                        const fullReplacement = core_1.getSystemPath(replacement);
                        reverseReplacements.set(fullReplacement, file);
                        return fullReplacement;
                    }
                    else {
                        return file;
                    }
                }
            });
        };
        const watcher = super.watch(mapReplacements(files), mapReplacements(dirs), mapReplacements(missing), startTime, options, newCallback, newCallbackUndelayed);
        return {
            close: () => watcher.close(),
            pause: () => watcher.pause(),
            getFileTimestamps: () => reverseTimestamps(watcher.getFileTimestamps()),
            getContextTimestamps: () => reverseTimestamps(watcher.getContextTimestamps()),
        };
    }
}
exports.VirtualWatchFileSystemDecorator = VirtualWatchFileSystemDecorator;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlydHVhbF9maWxlX3N5c3RlbV9kZWNvcmF0b3IuanMiLCJzb3VyY2VSb290IjoiLi8iLCJzb3VyY2VzIjpbInBhY2thZ2VzL25ndG9vbHMvd2VicGFjay9zcmMvdmlydHVhbF9maWxlX3N5c3RlbV9kZWNvcmF0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQTs7Ozs7O0dBTUc7QUFDSCwrQ0FBc0U7QUFLekQsUUFBQSxtQkFBbUIsR0FBaUMsT0FBTyxDQUN0RSxzQ0FBc0MsQ0FBQyxDQUFDO0FBRTFDO0lBQ0UsWUFDVSxnQkFBaUMsRUFDakMsb0JBQXlDO1FBRHpDLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBaUI7UUFDakMseUJBQW9CLEdBQXBCLG9CQUFvQixDQUFxQjtJQUMvQyxDQUFDO0lBRUcsYUFBYSxDQUFDLElBQVk7UUFDaEMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDL0MsTUFBTSxDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDO1FBQ2hFLENBQUM7UUFFRCxNQUFNLENBQUMsSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUVPLFNBQVMsQ0FBQyxJQUFZO1FBQzVCLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQy9DLE1BQU0sQ0FBQyxJQUFJLENBQUMsb0JBQW9CLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzlDLENBQUM7UUFFRCxNQUFNLENBQUMsSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUVELG9CQUFvQjtRQUNsQixNQUFNLENBQUMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLGlCQUFpQixFQUFFLENBQUM7SUFDdkQsQ0FBQztJQUVELElBQUksQ0FBQyxJQUFZLEVBQUUsUUFBeUI7UUFD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QVcsQ0FBQyxDQUFDLENBQUM7d0JBQ2hCLE1BQU0sZUFBZSxHQUFHLG9CQUFhLENBQUMsV0FBVyxDQUFDLENBQUM7d0JBQ25ELG1CQUFtQixDQUFDLEdBQUcsQ0FBQyxlQUFlLEVBQUUsSUFBSSxDQUFDLENBQUM7d0JBRS9DLE1BQU0sQ0FBQyxlQUFlLENBQUM7b0JBQ3pCLENBQUM7b0JBQUMsSUFBSSxDQUFDLENBQUM7d0JBQ04sTUFBTSxDQUFDLElBQUksQ0FBQztvQkFDZCxDQUFDO2dCQUNILENBQUM7WUFDSCxDQUFDLENBQUMsQ0FBQztRQUNMLENBQUMsQ0FBQztRQUVGLE1BQU0sT0FBTyxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQ3pCLGVBQWUsQ0FBQyxLQUFLLENBQUMsRUFDdEIsZUFBZSxDQUFDLElBQUksQ0FBQyxFQUNyQixlQUFlLENBQUMsT0FBTyxDQUFDLEVBQ3hCLFNBQVMsRUFDVCxPQUFPLEVBQ1AsV0FBVyxFQUNYLG9CQUFvQixDQUNyQixDQUFDO1FBRUYsTUFBTSxDQUFDO1lBQ0wsS0FBSyxFQUFFLEdBQUcsRUFBRSxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUU7WUFDNUIsS0FBSyxFQUFFLEdBQUcsRUFBRSxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUU7WUFDNUIsaUJBQWlCLEVBQUUsR0FBRyxFQUFFLENBQUMsaUJBQWlCLENBQUMsT0FBTyxDQUFDLGlCQUFpQixFQUFFLENBQUM7WUFDdkUsb0JBQW9CLEVBQUUsR0FBRyxFQUFFLENBQUMsaUJBQWlCLENBQUMsT0FBTyxDQUFDLG9CQUFvQixFQUFFLENBQUM7U0FDOUUsQ0FBQztJQUNKLENBQUM7Q0FDRjtBQTlHRCwwRUE4R0MiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEBsaWNlbnNlXG4gKiBDb3B5cmlnaHQgR29vZ2xlIEluYy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqXG4gKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhbiBNSVQtc3R5bGUgbGljZW5zZSB0aGF0IGNhbiBiZVxuICogZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBhdCBodHRwczovL2FuZ3VsYXIuaW8vbGljZW5zZVxuICovXG5pbXBvcnQgeyBQYXRoLCBnZXRTeXN0ZW1QYXRoLCBub3JtYWxpemUgfSBmcm9tICdAYW5ndWxhci1kZXZraXQvY29yZSc7XG5pbXBvcnQgeyBTdGF0cyB9IGZyb20gJ2ZzJztcbmltcG9ydCB7IFdlYnBhY2tDb21waWxlckhvc3QgfSBmcm9tICcuL2NvbXBpbGVyX2hvc3QnO1xuaW1wb3J0IHsgQ2FsbGJhY2ssIElucHV0RmlsZVN5c3RlbSwgTm9kZVdhdGNoRmlsZVN5c3RlbUludGVyZmFjZSB9IGZyb20gJy4vd2VicGFjayc7XG5cbmV4cG9ydCBjb25zdCBOb2RlV2F0Y2hGaWxlU3lzdGVtOiBOb2RlV2F0Y2hGaWxlU3lzdGVtSW50ZXJmYWNlID0gcmVxdWlyZShcbiAgJ3dlYnBhY2svbGliL25vZGUvTm9kZVdhdGNoRmlsZVN5c3RlbScpO1xuXG5leHBvcnQgY2xhc3MgVmlydHVhbEZpbGVTeXN0ZW1EZWNvcmF0b3IgaW1wbGVtZW50cyBJbnB1dEZpbGVTeXN0ZW0ge1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIF9pbnB1dEZpbGVTeXN0ZW06IElucHV0RmlsZVN5c3RlbSxcbiAgICBwcml2YXRlIF93ZWJwYWNrQ29tcGlsZXJIb3N0OiBXZWJwYWNrQ29tcGlsZXJIb3N0LFxuICApIHsgfVxuXG4gIHByaXZhdGUgX3JlYWRGaWxlU3luYyhwYXRoOiBzdHJpbmcpOiBCdWZmZXIgfCBudWxsIHtcbiAgICBpZiAodGhpcy5fd2VicGFja0NvbXBpbGVySG9zdC5maWxlRXhpc3RzKHBhdGgpKSB7XG4gICAgICByZXR1cm4gdGhpcy5fd2VicGFja0NvbXBpbGVySG9zdC5yZWFkRmlsZUJ1ZmZlcihwYXRoKSB8fCBudWxsO1xuICAgIH1cblxuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgcHJpdmF0ZSBfc3RhdFN5bmMocGF0aDogc3RyaW5nKTogU3RhdHMgfCBudWxsIHtcbiAgICBpZiAodGhpcy5fd2VicGFja0NvbXBpbGVySG9zdC5maWxlRXhpc3RzKHBhdGgpKSB7XG4gICAgICByZXR1cm4gdGhpcy5fd2VicGFja0NvbXBpbGVySG9zdC5zdGF0KHBhdGgpO1xuICAgIH1cblxuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgZ2V0VmlydHVhbEZpbGVzUGF0aHMoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3dlYnBhY2tDb21waWxlckhvc3QuZ2V0TmdGYWN0b3J5UGF0aHMoKTtcbiAgfVxuXG4gIHN0YXQocGF0aDogc3RyaW5nLCBjYWxsYmFjazogQ2FsbGJhY2s8U3RhdHM+KTogdm9pZCB7XG4gICAgY29uc3QgcmVzdWx0ID0gdGhpcy5fc3RhdFN5bmMocGF0aCk7XG4gICAgaWYgKHJlc3VsdCkge1xuICAgICAgY2FsbGJhY2sobnVsbCwgcmVzdWx0KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5faW5wdXRGaWxlU3lzdGVtLnN0YXQocGF0aCwgY2FsbGJhY2spO1xuICAgIH1cbiAgfVxuXG4gIHJlYWRkaXIocGF0aDogc3RyaW5nLCBjYWxsYmFjazogQ2FsbGJhY2s8c3RyaW5nW10+KTogdm9pZCB7XG4gICAgdGhpcy5faW5wdXRGaWxlU3lzdGVtLnJlYWRkaXIocGF0aCwgY2FsbGJhY2spO1xuICB9XG5cbiAgcmVhZEZpbGUocGF0aDogc3RyaW5nLCBjYWxsYmFjazogQ2FsbGJhY2s8QnVmZmVyPik6IHZvaWQge1xuICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuX3JlYWRGaWxlU3luYyhwYXRoKTtcbiAgICBpZiAocmVzdWx0KSB7XG4gICAgICBjYWxsYmFjayhudWxsLCByZXN1bHQpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLl9pbnB1dEZpbGVTeXN0ZW0ucmVhZEZpbGUocGF0aCwgY2FsbGJhY2spO1xuICAgIH1cbiAgfVxuXG4gIHJlYWRKc29uKHBhdGg6IHN0cmluZywgY2FsbGJhY2s6IENhbGxiYWNrPHt9Pik6IHZvaWQge1xuICAgIHRoaXMuX2lucHV0RmlsZVN5c3RlbS5yZWFkSnNvbihwYXRoLCBjYWxsYmFjayk7XG4gIH1cblxuICByZWFkbGluayhwYXRoOiBzdHJpbmcsIGNhbGxiYWNrOiBDYWxsYmFjazxzdHJpbmc+KTogdm9pZCB7XG4gICAgdGhpcy5faW5wdXRGaWxlU3lzdGVtLnJlYWRsaW5rKHBhdGgsIGNhbGxiYWNrKTtcbiAgfVxuXG4gIHN0YXRTeW5jKHBhdGg6IHN0cmluZyk6IFN0YXRzIHtcbiAgICBjb25zdCByZXN1bHQgPSB0aGlzLl9zdGF0U3luYyhwYXRoKTtcblxuICAgIHJldHVybiByZXN1bHQgfHwgdGhpcy5faW5wdXRGaWxlU3lzdGVtLnN0YXRTeW5jKHBhdGgpO1xuICB9XG5cbiAgcmVhZGRpclN5bmMocGF0aDogc3RyaW5nKTogc3RyaW5nW10ge1xuICAgIHJldHVybiB0aGlzLl9pbnB1dEZpbGVTeXN0ZW0ucmVhZGRpclN5bmMocGF0aCk7XG4gIH1cblxuICByZWFkRmlsZVN5bmMocGF0aDogc3RyaW5nKTogQnVmZmVyIHtcbiAgICBjb25zdCByZXN1bHQgPSB0aGlzLl9yZWFkRmlsZVN5bmMocGF0aCk7XG5cbiAgICByZXR1cm4gcmVzdWx0IHx8IHRoaXMuX2lucHV0RmlsZVN5c3RlbS5yZWFkRmlsZVN5bmMocGF0aCk7XG4gIH1cblxuICByZWFkSnNvblN5bmMocGF0aDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5faW5wdXRGaWxlU3lzdGVtLnJlYWRKc29uU3luYyhwYXRoKTtcbiAgfVxuXG4gIHJlYWRsaW5rU3luYyhwYXRoOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLl9pbnB1dEZpbGVTeXN0ZW0ucmVhZGxpbmtTeW5jKHBhdGgpO1xuICB9XG5cbiAgcHVyZ2UoY2hhbmdlcz86IHN0cmluZ1tdIHwgc3RyaW5nKTogdm9pZCB7XG4gICAgaWYgKHR5cGVvZiBjaGFuZ2VzID09PSAnc3RyaW5nJykge1xuICAgICAgdGhpcy5fd2VicGFja0NvbXBpbGVySG9zdC5pbnZhbGlkYXRlKGNoYW5nZXMpO1xuICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShjaGFuZ2VzKSkge1xuICAgICAgY2hhbmdlcy5mb3JFYWNoKChmaWxlTmFtZTogc3RyaW5nKSA9PiB0aGlzLl93ZWJwYWNrQ29tcGlsZXJIb3N0LmludmFsaWRhdGUoZmlsZU5hbWUpKTtcbiAgICB9XG4gICAgaWYgKHRoaXMuX2lucHV0RmlsZVN5c3RlbS5wdXJnZSkge1xuICAgICAgdGhpcy5faW5wdXRGaWxlU3lzdGVtLnB1cmdlKGNoYW5nZXMpO1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgVmlydHVhbFdhdGNoRmlsZVN5c3RlbURlY29yYXRvciBleHRlbmRzIE5vZGVXYXRjaEZpbGVTeXN0ZW0ge1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIF92aXJ0dWFsSW5wdXRGaWxlU3lzdGVtOiBWaXJ0dWFsRmlsZVN5c3RlbURlY29yYXRvcixcbiAgICBwcml2YXRlIF9yZXBsYWNlbWVudHM/OiBNYXA8UGF0aCwgUGF0aD4gfCAoKHBhdGg6IFBhdGgpID0+IFBhdGgpLFxuICApIHtcbiAgICBzdXBlcihfdmlydHVhbElucHV0RmlsZVN5c3RlbSk7XG4gIH1cblxuICB3YXRjaChcbiAgICBmaWxlczogc3RyaW5nW10sXG4gICAgZGlyczogc3RyaW5nW10sXG4gICAgbWlzc2luZzogc3RyaW5nW10sXG4gICAgc3RhcnRUaW1lOiBudW1iZXIgfCB1bmRlZmluZWQsXG4gICAgb3B0aW9uczoge30sXG4gICAgY2FsbGJhY2s6IGFueSwgIC8vIHRzbGludDpkaXNhYmxlLWxpbmU6bm8tYW55XG4gICAgY2FsbGJhY2tVbmRlbGF5ZWQ6IChmaWxlbmFtZTogc3RyaW5nLCB0aW1lc3RhbXA6IG51bWJlcikgPT4gdm9pZCxcbiAgKSB7XG4gICAgY29uc3QgcmV2ZXJzZVJlcGxhY2VtZW50cyA9IG5ldyBNYXA8c3RyaW5nLCBzdHJpbmc+KCk7XG4gICAgY29uc3QgcmV2ZXJzZVRpbWVzdGFtcHMgPSAobWFwOiBNYXA8c3RyaW5nLCBudW1iZXI+KSA9PiB7XG4gICAgICBmb3IgKGNvbnN0IGVudHJ5IG9mIEFycmF5LmZyb20obWFwLmVudHJpZXMoKSkpIHtcbiAgICAgICAgY29uc3Qgb3JpZ2luYWwgPSByZXZlcnNlUmVwbGFjZW1lbnRzLmdldChlbnRyeVswXSk7XG4gICAgICAgIGlmIChvcmlnaW5hbCkge1xuICAgICAgICAgIG1hcC5zZXQob3JpZ2luYWwsIGVudHJ5WzFdKTtcbiAgICAgICAgICBtYXAuZGVsZXRlKGVudHJ5WzBdKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICByZXR1cm4gbWFwO1xuICAgIH07XG5cbiAgICBjb25zdCBuZXdDYWxsYmFja1VuZGVsYXllZCA9IChmaWxlbmFtZTogc3RyaW5nLCB0aW1lc3RhbXA6IG51bWJlcikgPT4ge1xuICAgICAgY29uc3Qgb3JpZ2luYWwgPSByZXZlcnNlUmVwbGFjZW1lbnRzLmdldChmaWxlbmFtZSk7XG4gICAgICBpZiAob3JpZ2luYWwpIHtcbiAgICAgICAgdGhpcy5fdmlydHVhbElucHV0RmlsZVN5c3RlbS5wdXJnZShvcmlnaW5hbCk7XG4gICAgICAgIGNhbGxiYWNrVW5kZWxheWVkKG9yaWdpbmFsLCB0aW1lc3RhbXApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY2FsbGJhY2tVbmRlbGF5ZWQoZmlsZW5hbWUsIHRpbWVzdGFtcCk7XG4gICAgICB9XG4gICAgfTtcblxuICAgIGNvbnN0IG5ld0NhbGxiYWNrID0gKFxuICAgICAgZXJyOiBFcnJvciB8IG51bGwsXG4gICAgICBmaWxlc01vZGlmaWVkOiBzdHJpbmdbXSxcbiAgICAgIGNvbnRleHRNb2RpZmllZDogc3RyaW5nW10sXG4gICAgICBtaXNzaW5nTW9kaWZpZWQ6IHN0cmluZ1tdLFxuICAgICAgZmlsZVRpbWVzdGFtcHM6IE1hcDxzdHJpbmcsIG51bWJlcj4sXG4gICAgICBjb250ZXh0VGltZXN0YW1wczogTWFwPHN0cmluZywgbnVtYmVyPixcbiAgICApID0+IHtcbiAgICAgIC8vIFVwZGF0ZSBmaWxlVGltZXN0YW1wcyB3aXRoIHRpbWVzdGFtcHMgZnJvbSB2aXJ0dWFsIGZpbGVzLlxuICAgICAgY29uc3QgdmlydHVhbEZpbGVzU3RhdHMgPSB0aGlzLl92aXJ0dWFsSW5wdXRGaWxlU3lzdGVtLmdldFZpcnR1YWxGaWxlc1BhdGhzKClcbiAgICAgICAgLm1hcCgoZmlsZU5hbWUpID0+ICh7XG4gICAgICAgICAgcGF0aDogZmlsZU5hbWUsXG4gICAgICAgICAgbXRpbWU6ICt0aGlzLl92aXJ0dWFsSW5wdXRGaWxlU3lzdGVtLnN0YXRTeW5jKGZpbGVOYW1lKS5tdGltZSxcbiAgICAgICAgfSkpO1xuICAgICAgdmlydHVhbEZpbGVzU3RhdHMuZm9yRWFjaChzdGF0cyA9PiBmaWxlVGltZXN0YW1wcy5zZXQoc3RhdHMucGF0aCwgK3N0YXRzLm10aW1lKSk7XG4gICAgICBjYWxsYmFjayhcbiAgICAgICAgZXJyLFxuICAgICAgICBmaWxlc01vZGlmaWVkLm1hcCh2YWx1ZSA9PiByZXZlcnNlUmVwbGFjZW1lbnRzLmdldCh2YWx1ZSkgfHwgdmFsdWUpLFxuICAgICAgICBjb250ZXh0TW9kaWZpZWQubWFwKHZhbHVlID0+IHJldmVyc2VSZXBsYWNlbWVudHMuZ2V0KHZhbHVlKSB8fCB2YWx1ZSksXG4gICAgICAgIG1pc3NpbmdNb2RpZmllZC5tYXAodmFsdWUgPT4gcmV2ZXJzZVJlcGxhY2VtZW50cy5nZXQodmFsdWUpIHx8IHZhbHVlKSxcbiAgICAgICAgcmV2ZXJzZVRpbWVzdGFtcHMoZmlsZVRpbWVzdGFtcHMpLFxuICAgICAgICByZXZlcnNlVGltZXN0YW1wcyhjb250ZXh0VGltZXN0YW1wcyksXG4gICAgICApO1xuICAgIH07XG5cbiAgICBjb25zdCBtYXBSZXBsYWNlbWVudHMgPSAob3JpZ2luYWw6IHN0cmluZ1tdKTogc3RyaW5nW10gPT4ge1xuICAgICAgaWYgKCF0aGlzLl9yZXBsYWNlbWVudHMpIHtcbiAgICAgICAgcmV0dXJuIG9yaWdpbmFsO1xuICAgICAgfVxuICAgICAgY29uc3QgcmVwbGFjZW1lbnRzID0gdGhpcy5fcmVwbGFjZW1lbnRzO1xuXG4gICAgICByZXR1cm4gb3JpZ2luYWwubWFwKGZpbGUgPT4ge1xuICAgICAgICBpZiAodHlwZW9mIHJlcGxhY2VtZW50cyA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgIGNvbnN0IHJlcGxhY2VtZW50ID0gZ2V0U3lzdGVtUGF0aChyZXBsYWNlbWVudHMobm9ybWFsaXplKGZpbGUpKSk7XG4gICAgICAgICAgaWYgKHJlcGxhY2VtZW50ICE9PSBmaWxlKSB7XG4gICAgICAgICAgICByZXZlcnNlUmVwbGFjZW1lbnRzLnNldChyZXBsYWNlbWVudCwgZmlsZSk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgcmV0dXJuIHJlcGxhY2VtZW50O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnN0IHJlcGxhY2VtZW50ID0gcmVwbGFjZW1lbnRzLmdldChub3JtYWxpemUoZmlsZSkpO1xuICAgICAgICAgIGlmIChyZXBsYWNlbWVudCkge1xuICAgICAgICAgICAgY29uc3QgZnVsbFJlcGxhY2VtZW50ID0gZ2V0U3lzdGVtUGF0aChyZXBsYWNlbWVudCk7XG4gICAgICAgICAgICByZXZlcnNlUmVwbGFjZW1lbnRzLnNldChmdWxsUmVwbGFjZW1lbnQsIGZpbGUpO1xuXG4gICAgICAgICAgICByZXR1cm4gZnVsbFJlcGxhY2VtZW50O1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gZmlsZTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH07XG5cbiAgICBjb25zdCB3YXRjaGVyID0gc3VwZXIud2F0Y2goXG4gICAgICBtYXBSZXBsYWNlbWVudHMoZmlsZXMpLFxuICAgICAgbWFwUmVwbGFjZW1lbnRzKGRpcnMpLFxuICAgICAgbWFwUmVwbGFjZW1lbnRzKG1pc3NpbmcpLFxuICAgICAgc3RhcnRUaW1lLFxuICAgICAgb3B0aW9ucyxcbiAgICAgIG5ld0NhbGxiYWNrLFxuICAgICAgbmV3Q2FsbGJhY2tVbmRlbGF5ZWQsXG4gICAgKTtcblxuICAgIHJldHVybiB7XG4gICAgICBjbG9zZTogKCkgPT4gd2F0Y2hlci5jbG9zZSgpLFxuICAgICAgcGF1c2U6ICgpID0+IHdhdGNoZXIucGF1c2UoKSxcbiAgICAgIGdldEZpbGVUaW1lc3RhbXBzOiAoKSA9PiByZXZlcnNlVGltZXN0YW1wcyh3YXRjaGVyLmdldEZpbGVUaW1lc3RhbXBzKCkpLFxuICAgICAgZ2V0Q29udGV4dFRpbWVzdGFtcHM6ICgpID0+IHJldmVyc2VUaW1lc3RhbXBzKHdhdGNoZXIuZ2V0Q29udGV4dFRpbWVzdGFtcHMoKSksXG4gICAgfTtcbiAgfVxufVxuIl19